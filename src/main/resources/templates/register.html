<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragmentos/cabecera::cabecero-seccion}"></head>

<body class="bg-gradient-primary">

<div class="container">

    <div class="glass-card my-5" style="border: none; box-shadow: var(--shadow-strong);">
        <div class="card-body p-0">
            <!-- Nested Row within Card Body -->
            <div class="row">
                <div class="col-lg-5 d-none d-lg-block" style="background: linear-gradient(135deg, rgba(240, 147, 251, 0.8) 0%, rgba(245, 87, 108, 0.8) 100%); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                    <div style="text-align: center; color: white; z-index: 2;">
                        <i class="fas fa-user-plus fa-6x floating" style="margin-bottom: 20px; display: block;"></i>
                        <h2 style="font-family: 'Orbitron', monospace; font-weight: 700; margin-bottom: 10px;">Join Us</h2>
                        <p style="font-size: 1.1rem; opacity: 0.9;">Become part of the eCommerce revolution</p>
                    </div>
                    <!-- Animated background elements -->
                    <div style="position: absolute; top: 20%; left: 20%; width: 80px; height: 80px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: floating 4s ease-in-out infinite;"></div>
                    <div style="position: absolute; top: 60%; right: 20%; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: floating 3s ease-in-out infinite reverse;"></div>
                    <div style="position: absolute; bottom: 20%; left: 50%; width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: floating 5s ease-in-out infinite;"></div>
                </div>
                <div class="col-lg-7">
                    <div class="p-5">
                        <div class="text-center">
                            <h1 class="h4 mb-4" style="font-family: 'Orbitron', monospace; font-weight: 700; background: var(--secondary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" th:text="#{register.form.title}">Create</h1>
                        </div>

                        <!-- SECURE REGISTRATION FORM -->
                        <form class="user" th:action="@{/register}" method="post" th:object="${user}" id="secureRegisterForm">
                            <!-- CSRF Protection -->
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            
                            <div class="form-group row">
                                <div class="col-sm-6 mb-3 mb-sm-0">
                                    <input type="email" 
                                           class="form-control-modern"
                                           th:field="*{email}" 
                                           th:placeholder="'Email Address'"
                                           required
                                           autocomplete="email"
                                           maxlength="100"
                                           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                                           title="Please enter a valid email address" />
                                    <span th:if="${#fields.hasErrors('email')}" 
                                          class="text-danger small" 
                                          th:errors="*{email}" 
                                          style="color: #ff6b6b;"></span>
                                </div>

                                <div class="col-sm-6">
                                    <select class="form-control-modern" 
                                            th:field="*{role}" 
                                            required>
                                        <option value="">Select Role</option>
                                        <option value="USER">User</option>
                                        <option value="ADMIN">Admin</option>
                                    </select>
                                    <span th:if="${#fields.hasErrors('role')}" 
                                          class="text-danger small" 
                                          th:errors="*{role}" 
                                          style="color: #ff6b6b;"></span>
                                </div>
                            </div>

                            <div class="form-group row">
                                <div class="col-sm-6 mb-3 mb-sm-0">
                                    <input type="password" 
                                           class="form-control-modern"
                                           th:field="*{password}" 
                                           th:placeholder="'Password'"
                                           required
                                           autocomplete="new-password"
                                           minlength="8"
                                           maxlength="128"
                                           id="password"
                                           pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                                           title="Password must contain at least 8 characters, including uppercase, lowercase, number and special character" />
                                    <div class="password-strength mt-2" id="passwordStrength"></div>
                                </div>
                                
                                <div class="col-sm-6">
                                    <input type="password" 
                                           class="form-control-modern"
                                           th:placeholder="'Confirm Password'"
                                           required
                                           autocomplete="new-password"
                                           minlength="8"
                                           maxlength="128"
                                           id="confirmPassword" />
                                    <div class="password-match mt-2" id="passwordMatch"></div>
                                </div>
                            </div>
                            
                            <!-- Additional Security Fields -->
                            <div class="form-group row">
                                <div class="col-12">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" 
                                               class="custom-control-input" 
                                               id="termsAcceptance" 
                                               required>
                                        <label class="custom-control-label" for="termsAcceptance" style="color: var(--text-secondary);">
                                            I accept the <a href="#" class="text-primary" data-toggle="modal" data-target="#termsModal">Terms and Conditions</a>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Honeypot for Bot Protection -->
                            <div class="form-group" style="display: none;">
                                <input type="text" name="website" id="website" tabindex="-1" autocomplete="off">
                            </div>

                            <button type="submit" 
                                    class="btn btn-modern btn-block animate-pulse"
                                    id="registerButton"
                                    disabled>
                                Register Account
                            </button>
                            
                            <hr style="border-color: var(--glass-border);">

                            <!-- SECURITY: Disabled external registration for security -->
                            <div class="text-center">
                                <p style="color: var(--text-muted); font-size: 0.9rem;">
                                    <i class="fas fa-shield-alt"></i> 
                                    External registration temporarily disabled for security
                                </p>
                            </div>
                        </form>

                        <hr style="border-color: var(--glass-border);">
                        <div class="text-center">
                            <a class="small" th:href="@{/forgot-password}" style="color: var(--text-secondary); text-decoration: none;">Forgot Password?</a>
                        </div>
                        <div class="text-center">
                            <a class="small" th:href="@{/login}" style="color: var(--text-secondary); text-decoration: none;">Already have an account? Login!</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" role="dialog" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>By registering, you agree to our terms of service and privacy policy...</p>
                <!-- Add your actual terms here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-modern" data-dismiss="modal">I Understand</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript - Local only for security -->
<script th:src="@{/static/vendor/jquery/jquery.min.js}"></script>
<script th:src="@{/static/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

<!-- Core plugin JavaScript -->
<script th:src="@{/static/vendor/jquery-easing/jquery.easing.min.js}"></script>

<!-- Custom scripts for all pages -->
<script th:src="@{/static/js/sb-admin-2.min.js}"></script>

<!-- SECURITY: Form Validation and Security -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('secureRegisterForm');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');
        const termsCheckbox = document.getElementById('termsAcceptance');
        const registerButton = document.getElementById('registerButton');
        const passwordStrength = document.getElementById('passwordStrength');
        const passwordMatch = document.getElementById('passwordMatch');
        
        // Password strength checker
        function checkPasswordStrength(password) {
            let strength = 0;
            let feedback = [];
            
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            switch(strength) {
                case 0:
                case 1:
                    feedback = ['Very Weak', 'text-danger'];
                    break;
                case 2:
                    feedback = ['Weak', 'text-warning'];
                    break;
                case 3:
                    feedback = ['Medium', 'text-info'];
                    break;
                case 4:
                    feedback = ['Strong', 'text-success'];
                    break;
                case 5:
                    feedback = ['Very Strong', 'text-success'];
                    break;
            }
            
            return feedback;
        }
        
        // Password match checker
        function checkPasswordMatch() {
            if (confirmPassword.value === password.value && confirmPassword.value !== '') {
                passwordMatch.innerHTML = '<i class="fas fa-check text-success"></i> Passwords match';
                return true;
            } else if (confirmPassword.value !== '') {
                passwordMatch.innerHTML = '<i class="fas fa-times text-danger"></i> Passwords do not match';
                return false;
            } else {
                passwordMatch.innerHTML = '';
                return false;
            }
        }
        
        // Update button state
        function updateButtonState() {
            const passwordValid = password.value.length >= 8;
            const passwordsMatch = checkPasswordMatch();
            const termsAccepted = termsCheckbox.checked;
            
            registerButton.disabled = !(passwordValid && passwordsMatch && termsAccepted);
        }
        
        // Event listeners
        password.addEventListener('input', function() {
            const [text, className] = checkPasswordStrength(this.value);
            passwordStrength.innerHTML = `<span class="${className}">${text}</span>`;
            updateButtonState();
        });
        
        confirmPassword.addEventListener('input', function() {
            checkPasswordMatch();
            updateButtonState();
        });
        
        termsCheckbox.addEventListener('change', updateButtonState);
        
        // Form submission security
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Honeypot validation
            const honeypot = document.getElementById('website');
            if (honeypot.value) {
                // Bot detected, silently fail
                return;
            }
            
            // Final validation
            if (!checkPasswordMatch()) {
                alert('Passwords do not match!');
                return;
            }
            
            if (!termsCheckbox.checked) {
                alert('Please accept the terms and conditions.');
                return;
            }
            
            // Show loading state
            registerButton.disabled = true;
            registerButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
            
            // Submit form securely
            setTimeout(() => {
                form.submit();
            }, 1000);
        });
        
        // Initialize button state
        updateButtonState();
    });
</script>

</body>
</html>
