<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragmentos/cabecera::cabecero-seccion}"></head>

<body class="bg-gradient-primary">

    <div class="container">

        <!-- Outer Row -->
        <div class="row justify-content-center">

            <div class="col-xl-10 col-lg-12 col-md-9">

                <div class="glass-card my-5" style="border: none; box-shadow: var(--shadow-strong);">
                    <div class="card-body p-0">
                        <!-- Nested Row within Card Body -->
                        <div class="row">
                            <div class="col-lg-6 d-none d-lg-block" style="background: linear-gradient(135deg, rgba(79, 172, 254, 0.8) 0%, rgba(0, 242, 254, 0.8) 100%); display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                                <div style="text-align: center; color: white; z-index: 2;">
                                    <i class="fas fa-key fa-6x floating" style="margin-bottom: 20px; display: block;"></i>
                                    <h2 style="font-family: 'Orbitron', monospace; font-weight: 700; margin-bottom: 10px;">Reset Password</h2>
                                    <p style="font-size: 1.1rem; opacity: 0.9;">Get back to your account securely</p>
                                </div>
                                <!-- Animated background elements -->
                                <div style="position: absolute; top: 20%; left: 20%; width: 90px; height: 90px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: floating 4s ease-in-out infinite;"></div>
                                <div style="position: absolute; top: 60%; right: 20%; width: 70px; height: 70px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: floating 3s ease-in-out infinite reverse;"></div>
                                <div style="position: absolute; bottom: 20%; left: 50%; width: 110px; height: 110px; background: rgba(255,255,255,0.1); border-radius: 50%; animation: floating 5s ease-in-out infinite;"></div>
                            </div>
                            <div class="col-lg-6">
                                <div class="p-5">
                                    <div class="text-center">
                                        <h1 class="h4 mb-2" style="font-family: 'Orbitron', monospace; font-weight: 700; background: var(--success-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Forgot Your Password?</h1>
                                        <p class="mb-4" style="color: var(--text-secondary);">We get it, stuff happens. Just enter your email address below
                                            and we'll send you a link to reset your password!</p>
                                    </div>
                                    
                                    <!-- SECURE PASSWORD RESET FORM -->
                                    <form class="user" th:action="@{/forgot-password}" method="post" id="securePasswordResetForm">
                                        <!-- CSRF Protection -->
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        
                                        <div class="form-group">
                                            <input type="email" 
                                                   class="form-control-modern"
                                                   id="resetEmail" 
                                                   name="email"
                                                   th:placeholder="'Enter Email Address...'"
                                                   required
                                                   autocomplete="email"
                                                   maxlength="100"
                                                   pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                                                   title="Please enter a valid email address">
                                            <div class="invalid-feedback" id="emailError"></div>
                                        </div>
                                        
                                        <!-- Honeypot for Bot Protection -->
                                        <div class="form-group" style="display: none;">
                                            <input type="text" name="phone" id="phone" tabindex="-1" autocomplete="off">
                                        </div>
                                        
                                        <button type="submit" 
                                                class="btn btn-modern btn-block animate-pulse"
                                                id="resetButton"
                                                data-loading-text="Sending Reset Link...">
                                            Reset Password
                                        </button>
                                    </form>
                                    
                                    <hr style="border-color: var(--glass-border);">
                                    <div class="text-center">
                                        <a class="small" th:href="@{/register}" style="color: var(--text-secondary); text-decoration: none;">Create an Account!</a>
                                    </div>
                                    <div class="text-center">
                                        <a class="small" th:href="@{/login}" style="color: var(--text-secondary); text-decoration: none;">Already have an account? Login!</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <!-- Bootstrap core JavaScript - Local only for security -->
    <script th:src="@{/static/vendor/jquery/jquery.min.js}"></script>
    <script th:src="@{/static/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

    <!-- Core plugin JavaScript -->
    <script th:src="@{/static/vendor/jquery-easing/jquery.easing.min.js}"></script>

    <!-- Custom scripts for all pages -->
    <script th:src="@{/static/js/sb-admin-2.min.js}"></script>

    <!-- SECURITY: Form Validation and Rate Limiting -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('securePasswordResetForm');
            const resetButton = document.getElementById('resetButton');
            let attemptCount = 0;
            const maxAttempts = 3;
            const lockoutTime = 10 * 60 * 1000; // 10 minutes
            
            // Check if user is locked out
            const lockoutUntil = localStorage.getItem('passwordResetLockout');
            if (lockoutUntil && Date.now() < parseInt(lockoutUntil)) {
                const remainingTime = Math.ceil((parseInt(lockoutUntil) - Date.now()) / 1000 / 60);
                alert(`Password reset temporarily locked. Please try again in ${remainingTime} minutes.`);
                form.style.display = 'none';
                return;
            }
            
            // Honeypot validation
            const honeypot = document.getElementById('phone');
            if (honeypot.value) {
                // Bot detected, silently fail
                return;
            }
            
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Rate limiting
                if (attemptCount >= maxAttempts) {
                    const lockoutTime = Date.now() + (10 * 60 * 1000);
                    localStorage.setItem('passwordResetLockout', lockoutTime.toString());
                    alert('Too many password reset attempts. Please try again in 10 minutes.');
                    return;
                }
                
                // Input validation
                const email = document.getElementById('resetEmail').value.trim();
                
                if (!email) {
                    alert('Please enter your email address.');
                    return;
                }
                
                // Email format validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('Please enter a valid email address.');
                    return;
                }
                
                // Increment attempt counter
                attemptCount++;
                
                // Show loading state
                resetButton.disabled = true;
                resetButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending Reset Link...';
                
                // Submit form securely
                setTimeout(() => {
                    form.submit();
                }, 1000); // Small delay to prevent rapid submissions
            });
            
            // Clear lockout on successful page load
            if (window.location.search.includes('success')) {
                localStorage.removeItem('passwordResetLockout');
                attemptCount = 0;
            }
        });
    </script>

</body>

</html>